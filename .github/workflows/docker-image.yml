################################################
# NECESSARY GITHUB SECRETS TO SET              #
################################################
# secrets.imagename : e.g "<org>/<image>"
# secrets.registryuser
# secrets.registrypwd
# secrets.server : (not currently implemented)
################################################

name: Docker Image CI

# Leave out specific branches so this same workflow can be used on any branch
on:
  push:
  pull_request_target:
    types: [ opened, reopened, edited, synchronize, closed]

jobs:

  buildAndTest:
    runs-on: ubuntu-latest
    steps:

    - name: Set environment variables
      run: |
        tag=${{ github.ref }} && tag=${tag##*/}
        echo "tag=${tag}" >> $GITHUB_ENV

      # Checkout the commit that triggered the workflow
    - uses: actions/checkout@v2

    - name: Build the Docker image
      run: docker build --no-cache -t ${{ secrets.imagename }}:${{ env.tag }} .

    - name: Download sample wep app
      run: |
        wget -O $(pwd)/.github/testScripts/sample.war \
        https://tomcat.apache.org/tomcat-8.5-doc/appdev/sample/sample.war

    - name: Run the container
      run: |
        docker run \
        -e TOMCAT_USER_ID=$(id -u) \
        -e TOMCAT_GROUP_ID=$(getent group $USER | cut -d : -f3) \
        -v $(pwd)/.github/testScripts:/testScripts \
        -v $(pwd)/.github/testScripts:/usr/local/tomcat/webapps \
        -d \
        -p 8080:8080 \
        ${{ secrets.imagename }}:${{ env.tag }}

    - name: Run test script
      run: ./.github/testScripts/test.sh
